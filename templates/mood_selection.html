<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Selection</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <nav class="navbar navbar-dark bg-primary fixed-top">
        <div class="container-fluid d-flex justify-content-between">
            <a class="navbar-brand text-white fs-3">Music Application</a>
            <a href="/profile" class="btn btn-light">User Profile</a>
        </div>
    </nav>
    <script src="https://open.spotify.com/embed-podcast/iframe-api/v1" async></script>
</head>
<style>
    body {
        padding-top: 70px; /* Adjust according to navbar height */
        background-image: url("{{ url_for('static', filename='mood_chat.jpg') }}");
        background-size: cover; /* Ensures image covers the entire screen */
        background-position: center; /* Centers the image */ 
        background-repeat: no-repeat; /* Prevents repeating */ 
        background-attachment: fixed; /* Keeps image fixed while scrolling */
    }
</style>
<body class="d-flex justify-content-center align-items-center vh-100">
    <div class="container text-center">
        <h1>Select Your Mood</h1>

        <!-- Mood Selection Dropdown -->
        <select id="mood" class="form-select my-3">
            <option value="happy">Happy</option>
            <option value="sad">Sad</option>
            <option value="relaxed">Relaxed</option>
            <option value="excited">Excited</option>
        </select>

        <!-- Age Input Field -->
        <input type="number" id="age" class="form-control my-3" placeholder="Enter your age" min="0" max="100">

        <!-- Get Playlist Button -->
        <button class="btn btn-primary" onclick="getPlaylist()">Get Playlist</button>

        <h2 class="mt-3">Recommended Playlist:</h2>
        <div id="playlist-container">
            <div id="playlist-player"></div>

            <!-- Timer Display -->
            <h3 class="mt-3">Listening Time: <span id="timer">00:00:00</span></h3>

            <!-- Start & Stop Listening Buttons -->
            <button class="btn btn-success mt-2" onclick="startListening()">Start Listening</button>
            <button class="btn btn-danger mt-2" onclick="stopListening()">Stop Listening</button>

            <!-- Feedback Form -->
            <form id="feedback-form" class="mt-3" onsubmit="submitFeedback(event)">
                <label>Feedback:</label>
                <select name="feedback" id="feedback" class="form-select">
                    <option value="positive">Positive</option>
                    <option value="neutral">Neutral</option>
                    <option value="negative">Negative</option>
                </select>
                <button type="submit" class="btn btn-primary mt-2">Submit</button>
            </form>
        </div>
    </div>

    <script>
        let timerInterval;
        let totalSeconds = 0;
        let isRunning = false;
        let currentPlaylist = ""; // Stores the current playlist URL

        function formatTime(seconds) {
            let hrs = Math.floor(seconds / 3600);
            let mins = Math.floor((seconds % 3600) / 60);
            let secs = seconds % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            document.getElementById("timer").innerText = formatTime(totalSeconds);
        }

        function startListening() {
            if (!currentPlaylist) {
                alert("Please select a playlist first!");
                return;
            }
            if (!isRunning) {
                isRunning = true;
                timerInterval = setInterval(() => {
                    totalSeconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function stopListening() {
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
            }
        }

        window.onSpotifyIframeApiReady = (IFrameAPI) => {
            window.SpotifyEmbedController = IFrameAPI;
        };
        
        
        async function getPlaylist() {
            const mood = document.getElementById("mood").value;
            const age = document.getElementById("age").value;

            if (!age) {
                alert("Please enter your age!");
                return;
            }

            try {
                const response = await fetch(`/api/get_playlist?mood=${mood}&age=${age}`);
                if (!response.ok) throw new Error("Playlist not found");

                const data = await response.json();
                console.log("Response Data:", data);

                if (!data.playlist) {
                    document.getElementById("playlist-player").innerHTML = "<p>No playlist found!</p>";
                    return;
                }

                currentPlaylist = data.playlist; // Store the playlist URL

                document.getElementById("playlist-player").innerHTML = `<iframe 
                    src="${currentPlaylist.replace("open.spotify.com", "open.spotify.com/embed")}" 
                    width="100%" 
                    height="352" 
                    frameborder="0" 
                    allowtransparency="true" 
                    allow="encrypted-media">
                </iframe>`;

                // Reset the timer when a new playlist is loaded
                totalSeconds = 0;
                updateTimerDisplay();
                stopListening(); // Ensure the timer doesn't run automatically

            } catch (error) {
                console.error("Error:", error);
                document.getElementById("playlist-player").innerHTML = "<p>No playlist found!</p>";
                currentPlaylist = ""; // Clear the stored playlist if fetch fails
            }
        }

        function submitFeedback(event) {
            event.preventDefault();
            stopListening(); // Ensure timer is stopped before submitting

            if (!currentPlaylist) {
                alert("No playlist selected to submit feedback for!");
                return;
            }

            let feedbackValue = document.getElementById("feedback").value;
            let durationInSeconds = totalSeconds; // Total listening time in seconds
            let userId = 7; // Replace with actual user ID (you can fetch from session or API)
            
            let feedbackData = {
                user_id: userId,
                feedback: feedbackValue,
                duration: durationInSeconds,
                playlist: currentPlaylist // This should not be "Auto Playlist"
            };

            console.log("Sending feedback data:", feedbackData); // Debugging output

            // Send data to Flask backend
            fetch('/submit_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    feedback: feedbackValue,
                    duration: durationInSeconds,
                    playlist: currentPlaylist // Send the correct playlist link
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(`Feedback Recorded: ${feedbackValue}\nTotal Listening Time: ${document.getElementById("timer").textContent}`);
                console.log(data.message);

                if (data.new_playlist) {
                    embedPlaylist(data.new_playlist);
                    alert("Playlist replaced due to multiple negative feedbacks.");
                }
            })
            .catch(error => console.error("Error:", error));
        }
    </script>
</body>
</html>
