<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <nav class="navbar navbar-dark bg-primary fixed-top">
        <div class="container-fluid d-flex justify-content-between">
            <a class="navbar-brand text-white fs-3">Music Application</a>
            <a href="/profile" class="btn btn-light">User Profile</a>
        </div>
    </nav>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-image: url("{{ url_for('static', filename='mood_chat.jpg') }}");
            background-size: cover; /* Ensures image covers the entire screen */
            background-position: center; /* Centers the image */ 
            background-repeat: no-repeat; /* Prevents repeating */ 
            background-attachment: fixed; /* Keeps image fixed while scrolling */
        }
        #chatbox {
            width: 80%;
            max-width: 500px;
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px auto;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .bot-message, .user-message {
            text-align: left;
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            max-width: 80%;
        }
        .user-message {
            background: #d1e7dd;
            text-align: right;
            margin-left: auto;
        }
        .bot-message {
            background: #e7e7e7;
        }
        iframe {
            display: block;
            margin: 5px auto;
        }
        #timer {
            font-size: 18px;
            font-weight: bold;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Chat with AI</h1>
    <div id="chatbox"></div>
    <input type="text" id="user_input" placeholder="Type your message..." onkeypress="if(event.key === 'Enter') sendMessage()">
    <button onclick="sendMessage()">Send</button>

    <h3>Listening Timer: <span id="timer">00:00:00</span></h3>

    <button onclick="startListening()">Start Listening</button>
    <button onclick="stopListening()">Stop Listening</button>

    <form onsubmit="submitFeedback(event)">
        <label>Feedback:</label>
        <select id="feedback">
            <option value="positive">Positive</option>
            <option value="neutral">Neutral</option>
            <option value="negative">Negative</option>
        </select>
        <button type="submit">Submit Feedback</button>
    </form>

    <script>
        let startTime = null;
        let totalDuration = 0;
        let timerInterval = null;
        let currentPlaylist = ""; // Stores the current playlist URL

        function updateTimerDisplay() {
            let display = document.getElementById("timer");
            let seconds = totalDuration % 60;
            let minutes = Math.floor(totalDuration / 60) % 60;
            let hours = Math.floor(totalDuration / 3600);
            display.textContent = 
                String(hours).padStart(2, "0") + ":" +
                String(minutes).padStart(2, "0") + ":" +
                String(seconds).padStart(2, "0");
        }

        function startListening() {
            if (!startTime) {
                startTime = new Date().getTime();
            }
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    totalDuration++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function stopListening() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function submitFeedback(event) {
            event.preventDefault();
            stopListening(); // Stop timer on submission
            let feedbackValue = document.getElementById("feedback").value;
            alert(`Feedback Recorded: ${feedbackValue}\nTotal Listening Time: ${document.getElementById("timer").textContent}`);
        }

        async function sendMessage() {
            let userMessage = document.getElementById("user_input").value.trim();
            let chatBox = document.getElementById("chatbox");

            if (!userMessage) return;

            displayMessage(userMessage, "user");

            let response = await fetch("/chatbot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: userMessage }),
            });

            let data = await response.json();

            if (data.response) {
                displayMessage(data.response, "bot");
            } else {
                displayMessage("Error getting response.", "bot");
            }

            if (data.playlist) {
                embedPlaylist(data.playlist);
            }

            document.getElementById("user_input").value = "";
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function displayMessage(text, sender) {
            let chatBox = document.getElementById("chatbox");
            let messageDiv = document.createElement("div");
            messageDiv.classList.add(sender === "bot" ? "bot-message" : "user-message");
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function embedPlaylist(playlistUrl) {
            currentPlaylist = playlistUrl; // Store before updating UI
            let chatBox = document.getElementById("chatbox");
            let existingIframe = document.querySelector("iframe");
            if (existingIframe) {
                existingIframe.remove();
            }

            let iframe = document.createElement("iframe");
            iframe.src = playlistUrl;
            iframe.width = "300";
            iframe.height = "380";
            iframe.frameBorder = "0";
            iframe.allowTransparency = "true";
            iframe.allow = "encrypted-media";
            chatBox.appendChild(iframe);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Store the playlist URL
            currentPlaylist = playlistUrl;
        }

        function submitFeedback(event) {
    event.preventDefault();
    stopListening(); // Ensure timer is stopped before submitting

    let feedbackValue = document.getElementById("feedback").value;
    let durationInSeconds = totalDuration; // Total listening time in seconds
    let userId = 7; // Replace with actual user ID (you can fetch from session or API)

    let feedbackData = {
                user_id: userId,
                feedback: feedbackValue,
                duration: durationInSeconds,
                playlist: currentPlaylist // This should not be "Auto Playlist"
            };

    // Send data to Flask backend
    fetch('/submit_feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            user_id: userId,
            feedback: feedbackValue,
            duration: durationInSeconds,
            playlist: currentPlaylist
        })
    })
    .then(response => response.json())
    .then(data => {
        alert(`Feedback Recorded: ${feedbackValue}\nTotal Listening Time: ${document.getElementById("timer").textContent}`);
        console.log(data.message);

        if (data.new_playlist) {
            currentPlaylist = data.new_playlist;
            embedPlaylist(currentPlaylist);
            alert("Playlist replaced due to multiple negative feedbacks.");
        }
    })
    .catch(error => console.error("Error:", error));
}

    </script>
</body>
</html>
